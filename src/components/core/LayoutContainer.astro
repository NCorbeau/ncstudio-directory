---
// src/components/core/LayoutContainer.astro
import CardLayout from '../layouts/CardLayout.astro';
import ListLayout from '../layouts/ListLayout.astro';
import MagazineLayout from '../layouts/MagazineLayout.astro';
import MapLayout from '../layouts/MapLayout.astro';
import TableLayout from '../layouts/TableLayout.astro';
import LayoutSwitcher from './LayoutSwitcher.astro';

const { 
  listings, 
  directory, 
  currentLayout,
  categories = [],
  searchParams = '',
  directoryId
} = Astro.props;

// Get available layouts from directory config
const availableLayouts = directory.availableLayouts || ['Card'];
const defaultLayout = directory.defaultLayout || 'Card';

// For server-side rendering, we'll use the provided currentLayout or the default
const initialLayout = currentLayout && availableLayouts.includes(currentLayout) 
  ? currentLayout 
  : defaultLayout;
---

<div class="layout-container">
  {availableLayouts.length > 1 && (
    <LayoutSwitcher 
      availableLayouts={availableLayouts}
      currentLayout={initialLayout}
      directoryId={directoryId}
      searchParams={searchParams}
    />
  )}
  
  <!-- All layouts are pre-rendered but hidden initially -->
  <div id="layout-wrapper">
    <div id="card-layout" class="layout-content" style={initialLayout === 'Card' ? '' : 'display: none;'}>
      <CardLayout 
        listings={listings} 
        directory={directory}
        categories={categories}
      />
    </div>
    
    <div id="list-layout" class="layout-content" style={initialLayout === 'List' ? '' : 'display: none;'}>
      <ListLayout
        listings={listings}
        directory={directory}
        categories={categories}
        directoryId={directoryId}
      />
    </div>
    
    <div id="magazine-layout" class="layout-content" style={initialLayout === 'Magazine' ? '' : 'display: none;'}>
      <MagazineLayout
        listings={listings}
        directory={directory}
        categories={categories}
        directoryId={directoryId}
      />
    </div>
    
    <div id="map-layout" class="layout-content" style={initialLayout === 'Map' ? '' : 'display: none;'}>
      <MapLayout
        listings={listings}
        directory={directory}
        categories={categories}
      />
    </div>
    
    <div id="table-layout" class="layout-content" style={initialLayout === 'Table' ? '' : 'display: none;'}>
      <TableLayout
        listings={listings}
        directory={directory}
        categories={categories}
      />
    </div>
  </div>
</div>

<script>
  // Import the layout switcher module
  import { initLayoutSwitcher } from '../../scripts/layoutSwitcher.js';
  
  // Define variables to pass to the script
  const availableLayouts = ['Card', 'List', 'Magazine', 'Map', 'Table'].filter(layout => 
    document.getElementById(`${layout.toLowerCase()}-layout`)
  );
  const defaultLayout = 'Card';
  const initialLayout = document.querySelector('.layout-content[style=""]')?.id.replace('-layout', '') || defaultLayout;
  const directoryId = window.location.pathname.split('/')[1];
  
  // Initialize the layout switcher
  initLayoutSwitcher(availableLayouts, defaultLayout, initialLayout, directoryId);
</script>

<style>
  .layout-container {
    margin-bottom: 2rem;
  }
  
  .layout-content {
    min-height: 400px; /* Ensure consistent height when switching layouts */
  }
</style>